angular.module("fsCordova",[]).service("CordovaService",["$document","$q",function(a,b){var c=b.defer(),d=!1;this.ready=c.promise,document.addEventListener("deviceready",function(){d=!0,c.resolve(window.cordova)}),setTimeout(function(){d||window.cordova&&c.resolve(window.cordova)},3e3)}]),angular.module("lvshackApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngStorage","fsCordova"]).config(["$routeProvider","$sceDelegateProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/shack",{templateUrl:"views/shack.html",controller:"ShackCtrl"}).otherwise({redirectTo:"/"}),b.resourceUrlWhitelist(["self","https://embed.spotify.com/**"])}]).run(["$rootScope","$location","$localStorage","$sessionStorage",function(a,b,c){a.$storage=c,a.url="http://ec2-54-204-111-15.compute-1.amazonaws.com/",console.log(a.$storage.email),b.path("undefined"!=typeof a.$storage.email?"/shack":"/")}]),angular.module("lvshackApp").controller("MainCtrl",["$rootScope","$scope","$http","$localStorage","$sessionStorage","$location",function(a,b,c,d,e,f){b.$storage=d,b.updateEmail=function(){"undefined"!=typeof b.email?(b.$storage.email=b.email,f.path("/shack")):"undefined"!=typeof b.$storage.email&&f.path("/")}}]),angular.module("lvshackApp").factory("Bluetoothle",["$rootScope","phonegapReady",function(a,b){return{initialize:b(function(b,c){navigator.bluetoothle.initialize(function(){console.log("init bluetooth");var c=this,d=arguments;b&&a.$apply(function(){b.apply(c,d)})},function(){var b=this,d=arguments;c&&a.$apply(function(){c.apply(b,d)})})})}}]),angular.module("lvshackApp").factory("Base64",function(){function a(a){var c,d,e,f,g,h,i,j=new Array,k=0,l=a;if(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),l!=a&&alert("Warning! Characters outside Base64 range in input string ignored."),a.length%4)return alert("Error: Input length is not a multiple of 4 bytes."),"";for(var m=0;k<a.length;)f=b.indexOf(a.charAt(k++)),g=b.indexOf(a.charAt(k++)),h=b.indexOf(a.charAt(k++)),i=b.indexOf(a.charAt(k++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,j[m++]=c,64!=h&&(j[m++]=d),64!=i&&(j[m++]=e);return j}var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{Convert:function(b){for(var c=a(b),d="",e=0;e<c.length;e++)d=d+(c[e]<16?"0":"")+c[e].toString(16);return d}}}),angular.module("lvshackApp").controller("ShackCtrl",["$rootScope","$scope","$http","$localStorage","$sessionStorage","$timeout","Base64","CordovaService",function(a,b,c,d,e,f,g,h){function i(a){"initialized"==a.status?(console.log("Bluetooth initialized successfully, starting scan for beacons..."),window.bluetoothle.startScan(k,m,q)):console.log("Unexpected initialize status: "+a.status)}function j(a){console.log("Initialize error: "+a.error+" - "+a.message)}function k(a){if(b.scanning=!0,"scanResult"===a.status){var c=g.Convert(a.advertisement),d=c.substring(18,50),e=c.substring(50,54),f=c.substring(54,58),h=~parseInt("0xFFFFFF"+c.substring(58,60));a.uuid=d,a.major=e,a.minor=Number(f),a.power=h;var i=a.power+a.rssi;a.dis=0>i?2:0,console.log(d+":"+e+":"+f+":"+h);var j=!1;b.beacons.forEach(function(c,d){c.advertisement===a.advertisement&&(j=!0,b.beacons[d]=a,l(a))}),j===!1&&(b.beacons.push(a),l(a)),b.$apply()}else"scanStarted"===a.status?(b.scanning=!0,console.log("Scan was started successfully, stopping in 60 seconds"),s=setTimeout(p,6e4)):console.log("Unexpected start scan status: "+a.status)}function l(b){c({url:a.url+"beacon/"+b.minor,method:"PUT",timeout:2e3,data:JSON.stringify({distance:b.dis}),headers:{"Content-Type":"application/json"}}).success(function(a){console.log(a)}).error(function(a){console.log(a)})}function m(a){b.scanning=!1,console.log("Start scan error: "+a.error+" - "+a.message)}function n(a){b.scanning=!1,console.log("scanStopped"==a.status?"Scan was stopped successfully":"Unexpected stop scan status: "+a.status)}function o(a){b.scanning=!1,console.log("Stop scan error: "+a.error+" - "+a.message)}function p(){console.log("Scan time out, stopping"),window.bluetoothle.stopScan(n,o)}b.$storage=d,b.modalBeacon={},b.modal=!1,b.scanning=!1,b.beacons=[];var q={serviceAssignedNumbers:[]},r=!1,s=null;console.log("Starting main"),h.ready.then(function(){console.log("Cordova ready"),r=!0,b.scanNow()}),b.scanNow=function(){r===!0?(console.log("Is initialized = "+window.bluetoothle.isInitialized()),window.bluetoothle.isInitialized()!==!0?window.bluetoothle.initialize(i,j):(console.log("Is Scanning = "+window.bluetoothle.isScanning()),window.bluetoothle.isScanning()!==!0?(b.scanning=!1,window.bluetoothle.startScan(k,m,q)):b.scanning=!0)):console.log("Cordova not ready")},b.modalOpen=function(a){console.log(a),b.modalBeacon=a,b.modal=!0},b.modalClose=function(){b.modalBeacon={},b.modal=!1},b.openWebsite=function(a){window.open(a,"_system")}}]);